<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Watch Guyana</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/exif-js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the install button and toast notifications */
        #install-button {
            /* display: none; */ /* Removed to make the button visible by default */
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .toast.error {
            background-color: #ef4444; /* red-500 */
        }
         .toast.success {
            background-color: #22c55e; /* green-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-2xl">

        <!-- Header -->
        <header class="bg-green-600 text-white rounded-lg shadow-lg p-6 mb-6 text-center">
            <h1 class="text-4xl font-bold">Wildlife Watch Guyana</h1>
            <p class="text-green-200 mt-2">Online and offline wildlife sighting and reporting app.</p>
            <div id="clock" class="text-sm text-green-100 mt-4 font-mono"></div>
        </header>

        <!-- Main Content: Reporting Form -->
        <main class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Report a New Sighting</h2>

            <form id="report-form" class="space-y-4">
                <div>
                    <label for="photo" class="block text-sm font-medium text-gray-700">Upload Photo</label>
                    <input type="file" id="photo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" required>
                    <img id="preview" class="mt-4 rounded-lg hidden max-h-60 mx-auto" alt="Image preview">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                        <input type="number" step="any" id="latitude" placeholder="e.g., 6.8013" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                        <input type="number" step="any" id="longitude" placeholder="e.g., -58.1551" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <div>
                    <label for="animal-name" class="block text-sm font-medium text-gray-700">Animal Name (or best guess)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <input type="text" id="animal-name" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Jaguar">
                        <button type="button" id="ai-suggest-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition disabled:opacity-50" disabled>Get AI Suggestion</button>
                    </div>
                </div>
                 
                <div id="facts-container" class="hidden">
                    <button type="button" id="get-facts-btn" class="w-full mt-2 px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition">Learn about this animal!</button>
                    <div id="animal-facts" class="mt-4 p-4 bg-gray-50 rounded-lg text-sm"></div>
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Describe the animal's behavior, habitat, or any other details."></textarea>
                </div>

                <button type="submit" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">Send Report</button>
            </form>
        </main>
        
        <!-- Pending Reports Section -->
        <section id="pending-reports-section" class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Pending Reports (Offline)</h2>
            <div id="pending-reports" class="space-y-4">
                <p class="text-gray-500">No pending reports.</p>
            </div>
             <button id="sync-button" class="mt-4 w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition hidden">Sync Now</button>
        </section>

        <!-- Install App Button -->
         <div class="mt-6 text-center">
            <button id="install-button" class="py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                Install Wildlife Watch App
            </button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Guidance FAB -->
    <button id="guidance-fab" class="fixed bottom-6 right-6 bg-teal-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl font-bold hover:bg-teal-600 transition z-20">?</button>

    <!-- Guidance Modal -->
    <div id="guidance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold">Ask a Wildlife Expert</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="guidance-query" class="block text-sm font-medium text-gray-700">Your Question:</label>
                    <textarea id="guidance-query" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., What should I do if I see a snake?"></textarea>
                </div>
                <button id="ask-gemini-btn" class="w-full py-2 px-4 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700">Ask Gemini</button>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold mb-2">Guidance:</h4>
                    <div id="guidance-response" class="text-sm space-y-2 prose"><p class="text-gray-500">Ask a question to get guidance from our AI assistant.</p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PWA Service Worker & Install Logic ---
        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        window.addEventListener('load', () => {
            // Hide install button if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installButton.style.display = 'none';
            }
            // Register the service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service worker registered successfully', reg))
                    .catch(err => console.error('Service worker registration failed:', err));
            }
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('`beforeinstallprompt` event was fired.');
        });
        
        installButton.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installButton.style.display = 'none';
          } else {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                showToast("To install, tap the Share button and then 'Add to Home Screen'.", 'success');
            } else {
                showToast("Installation is not supported on this browser or the app is already installed.", 'error');
            }
          }
        });

        // --- App Logic ---
        const form = document.getElementById('report-form');
        const photoInput = document.getElementById('photo');
        const preview = document.getElementById('preview');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const animalNameInput = document.getElementById('animal-name');
        const notesInput = document.getElementById('notes');
        const pendingReportsContainer = document.getElementById('pending-reports');
        const syncButton = document.getElementById('sync-button');
        const aiSuggestBtn = document.getElementById('ai-suggest-btn');
        const getFactsBtn = document.getElementById('get-facts-btn');
        const factsContainer = document.getElementById('facts-container');
        const animalFactsDiv = document.getElementById('animal-facts');
        const guidanceFab = document.getElementById('guidance-fab');
        const guidanceModal = document.getElementById('guidance-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const askGeminiBtn = document.getElementById('ask-gemini-btn');
        const guidanceQueryInput = document.getElementById('guidance-query');
        const guidanceResponseDiv = document.getElementById('guidance-response');
        
        let db;

        // --- IndexedDB for Offline Storage ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('wildlifeDB', 1);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('reports')) {
                        db.createObjectStore('reports', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = event => { db = event.target.result; resolve(db); };
                request.onerror = event => { console.error('IndexedDB error:', event.target.errorCode); reject(event.target.errorCode); };
            });
        }
        
        function saveReport(report) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['reports'], 'readwrite');
                const store = transaction.objectStore('reports');
                const request = store.add(report);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject('Could not save report: ' + event.target.error);
            });
        }

        function getPendingReports() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['reports'], 'readonly');
                const store = transaction.objectStore('reports');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Could not get reports: ' + event.target.error);
            });
        }

        function deleteReport(id) {
             return new Promise((resolve, reject) => {
                const transaction = db.transaction(['reports'], 'readwrite');
                const store = transaction.objectStore('reports');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject('Could not delete report: ' + event.target.error);
            });
        }


        // --- Image & Geotag Handling ---
        photoInput.addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                aiSuggestBtn.disabled = false;
            };
            reader.readAsDataURL(file);
            latitudeInput.value = '';
            longitudeInput.value = '';
            EXIF.getData(file, function() {
                const lat = EXIF.getTag(this, "GPSLatitude");
                const lon = EXIF.getTag(this, "GPSLongitude");
                if (lat && lon) {
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";
                    const latitude = convertDMSToDD(lat[0], lat[1], lat[2], latRef);
                    const longitude = convertDMSToDD(lon[0], lon[1], lon[2], lonRef);
                    latitudeInput.value = latitude.toFixed(6);
                    longitudeInput.value = longitude.toFixed(6);
                    showToast('GPS coordinates extracted from photo!', 'success');
                } else {
                    showToast('No GPS data found in photo. Please enter manually.', 'error');
                }
            });
        }
        
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = degrees + minutes / 60 + seconds / 3600;
            if (direction === "S" || direction === "W") { dd = dd * -1; }
            return dd;
        }

        // --- Form Submission ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const photoFile = photoInput.files[0];
            if (!photoFile) {
                showToast('Please upload a photo.', 'error');
                return;
            }
            const reportData = {
                latitude: latitudeInput.value,
                longitude: longitudeInput.value,
                animalName: animalNameInput.value,
                notes: notesInput.value,
                timestamp: new Date().toISOString()
            };

            if (navigator.onLine) {
                showToast('Preparing email...', 'success');
                let emailBody = `
Sighting: ${reportData.animalName || 'Unknown'}
Coordinates: ${reportData.latitude}, ${reportData.longitude}
Notes: ${reportData.notes}
Timestamp: ${new Date(reportData.timestamp).toLocaleString()}

IMPORTANT: Please attach the photo of the sighting to this email manually.
--------------------------------------
                `;
                const mailtoLink = `mailto:wildlifewatchgy@gmail.com?subject=New Wildlife Sighting: ${reportData.animalName || 'Unknown'}&body=${encodeURIComponent(emailBody)}`;
                window.location.href = mailtoLink;
                form.reset();
                preview.classList.add('hidden');
                aiSuggestBtn.disabled = true;
                factsContainer.classList.add('hidden');
                animalFactsDiv.innerHTML = '';
            } else {
                showToast('You are offline. Saving report to send later.', 'success');
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const report = { ...reportData, photo: reader.result };
                    try {
                        await saveReport(report);
                        form.reset();
                        preview.classList.add('hidden');
                        aiSuggestBtn.disabled = true;
                        factsContainer.classList.add('hidden');
                        animalFactsDiv.innerHTML = '';
                        loadPendingReports();
                    } catch (err) {
                        showToast('Failed to save report locally.', 'error');
                        console.error(err);
                    }
                };
                reader.readAsDataURL(photoFile);
            }
        });

        // --- Display & Sync Reports ---
        async function loadPendingReports() {
            try {
                const reports = await getPendingReports();
                pendingReportsContainer.innerHTML = '';
                if (reports.length === 0) {
                    pendingReportsContainer.innerHTML = '<p class="text-gray-500">No pending reports.</p>';
                    syncButton.classList.add('hidden');
                } else {
                    syncButton.classList.remove('hidden');
                    reports.forEach(report => {
                        const reportEl = document.createElement('div');
                        reportEl.className = 'p-4 border rounded-lg bg-gray-50';
                        reportEl.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <img src="${report.photo}" class="w-20 h-20 object-cover rounded-md">
                                <div class="flex-1">
                                    <p class="font-bold">${report.animalName || 'Unnamed Sighting'}</p>
                                    <p class="text-sm text-gray-600">Coords: ${report.latitude}, ${report.longitude}</p>
                                    <p class="text-xs text-gray-400">Saved: ${new Date(report.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                        `;
                        pendingReportsContainer.appendChild(reportEl);
                    });
                }
            } catch(err) {
                 console.error('Failed to load reports:', err);
            }
        }
        
        syncButton.addEventListener('click', syncReports);

        async function syncReports() {
            if (!navigator.onLine) { showToast('You are offline. Cannot sync.', 'error'); return; }
            const reports = await getPendingReports();
            if (reports.length === 0) { showToast('No reports to sync.', 'success'); return; }
            showToast(`Syncing ${reports.length} reports...`, 'success');
            let emailBody = reports.map(report => `
Sighting: ${report.animalName || 'Unknown'}
Coordinates: ${report.latitude}, ${report.longitude}
Notes: ${report.notes}
Timestamp: ${new Date(report.timestamp).toLocaleString()}
(Image data is not included in this email)
--------------------------------------
            `).join('');
            const mailtoLink = `mailto:wildlifewatchgy@gmail.com?subject=Wildlife Sightings Sync&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailtoLink;
            setTimeout(async () => {
                for(const report of reports) { await deleteReport(report.id); }
                showToast('Sync complete! Local reports cleared.', 'success');
                loadPendingReports();
            }, 2000);
        }
        
        // --- Gemini API Calls ---
        const GEMINI_API_KEY = ""; // PASTE YOUR GEMINI API KEY HERE
        
        async function geminiApiCall(payload, model = 'gemini-2.5-flash-preview-05-20') {
             if (!GEMINI_API_KEY) {
                showToast("Gemini API key is not set. Please add it to the script.", "error");
                throw new Error("API key not set.");
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) { throw new Error(`API call failed with status ${response.status}`); }
            return response.json();
        }

        aiSuggestBtn.addEventListener('click', async () => {
            const photoFile = photoInput.files[0];
            if (!photoFile) { showToast('Please upload a photo first.', 'error'); return; }
            aiSuggestBtn.textContent = 'Analyzing...';
            aiSuggestBtn.disabled = true;
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const payload = { contents: [{ parts: [ { text: "Identify the animal in this photo. Provide only the common name." }, { inlineData: { mimeType: photoFile.type, data: base64Data } } ] }] };
                try {
                    const result = await geminiApiCall(payload);
                    const animalName = result.candidates[0].content.parts[0].text.trim();
                    animalNameInput.value = animalName;
                    factsContainer.classList.remove('hidden');
                    showToast('AI suggestion received!', 'success');
                } catch (error) {
                    console.error('Gemini API error:', error);
                    showToast('Could not get AI suggestion.', 'error');
                } finally {
                    aiSuggestBtn.textContent = 'Get AI Suggestion';
                    aiSuggestBtn.disabled = false;
                }
            };
            reader.readAsDataURL(photoFile);
        });

        getFactsBtn.addEventListener('click', async () => {
            const animalName = animalNameInput.value;
            if (!animalName) { showToast('No animal name to get facts for.', 'error'); return; }
            getFactsBtn.textContent = 'Fetching Facts...';
            getFactsBtn.disabled = true;
            animalFactsDiv.innerHTML = '<p>Loading...</p>';
            const payload = { contents: [{ parts: [{ text: `Provide a short, interesting paragraph about the ${animalName}, focusing on its presence or significance in Guyana.` }] }] };
            try {
                const result = await geminiApiCall(payload);
                const facts = result.candidates[0].content.parts[0].text;
                animalFactsDiv.innerHTML = `<p>${facts}</p>`;
            } catch (error) {
                console.error('Gemini API error:', error);
                animalFactsDiv.innerHTML = '<p class="text-red-500">Could not fetch facts at this time.</p>';
            } finally {
                getFactsBtn.textContent = 'Learn about this animal!';
                getFactsBtn.disabled = false;
            }
        });
        
        // --- Guidance Feature ---
        guidanceFab.addEventListener('click', () => guidanceModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => guidanceModal.classList.add('hidden'));
        guidanceModal.addEventListener('click', (e) => { if (e.target === guidanceModal) { guidanceModal.classList.add('hidden'); } });
        askGeminiBtn.addEventListener('click', handleGuidanceQuery);

        async function handleGuidanceQuery() {
            const query = guidanceQueryInput.value;
            if (!query) { showToast('Please enter a question.', 'error'); return; }
            askGeminiBtn.textContent = 'Thinking...';
            askGeminiBtn.disabled = true;
            guidanceResponseDiv.innerHTML = '<p>Loading...</p>';
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: "You are a helpful wildlife expert and guide for Guyana. Answer the user's questions concisely and accurately, focusing on local species, conservation efforts, and safe wildlife interaction practices in Guyana. Format your response using simple HTML for readability, like paragraphs <p> and lists <ul><li>." }] }
            };
            try {
                const result = await geminiApiCall(payload);
                const guidance = result.candidates[0].content.parts[0].text;
                guidanceResponseDiv.innerHTML = guidance;
            } catch (error) {
                console.error('Gemini guidance error:', error);
                guidanceResponseDiv.innerHTML = '<p class="text-red-500">Sorry, I could not get guidance at this time.</p>';
            } finally {
                askGeminiBtn.textContent = 'Ask Gemini';
                askGeminiBtn.disabled = false;
            }
        }


        // --- Utilities ---
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }
        
        function updateClock() {
            const clockEl = document.getElementById('clock');
            const options = { timeZone: 'America/Guyana', hour12: true, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            clockEl.textContent = new Date().toLocaleString('en-US', options);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await openDB();
            loadPendingReports();
            updateClock();
            setInterval(updateClock, 1000);
            window.addEventListener('online', () => syncButton.classList.remove('hidden'));
            window.addEventListener('offline', () => syncButton.classList.add('hidden'));
        });
    </script>
</body>
</html>
